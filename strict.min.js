;(function(){"use strict";var e=this,t=typeof exports!="undefined"?exports:e.Strict={},n=Object.prototype.toString,r=Array.prototype.slice,i=e._;!i&&typeof require!="undefined"&&(i=require("underscore"));var s=e.Backbone;!s&&typeof require!="undefined"&&(s=require("backbone"));var o=function(){},u=function(e,t,n){var r;return t&&t.hasOwnProperty("constructor")?r=t.constructor:r=function(){return e.apply(this,arguments)},i.extend(r,e),o.prototype=e.prototype,r.prototype=new o,t&&i.extend(r.prototype,t),n&&i.extend(r,n),r.prototype.constructor=r,r.__super__=e.prototype,r},a=function(e,t){var n=u(this,e,t);return n.extend=this.extend,n},f=t.Mixins={define:function(e,t){Object.defineProperty(this,e,t)},defineGetter:function(e,t){this.define(e,{get:t.bind(this)})},defineSetter:function(e,t){this.define(e,{set:t.bind(this)})}},l=t.Registry=function(){this._cache={},this._namespaces={}};i.extend(l.prototype,{_getCache:function(e){return e?(this._namespaces[e]||(this._namespaces[e]={}),this._namespaces[e]):this._cache},lookup:function(e,t,n){var r=this._getCache(n);return r&&r[e+t]},store:function(e){var t=this._getCache(e._namespace),n=e.type+e.id;return t[n]=t[n]||e,this},remove:function(e,t,n){var r=this._getCache(n);return this.lookup.apply(this,arguments)?(delete r[e+t],!0):!1}}),t.registry=new l;var c=t.Model=function(e,n){if(!(this instanceof c))return new c(e,n);e=e||{},n=n||{};var r,s=i.defaults(n||{},{seal:!0});if(e.id)if(r=t.registry.lookup(this.type,e.id,s.namespace))return r;this._namespace=s.namespace,this._initted=!1,this._deps={},this._initProperties(),this._cache={},this._verifyRequired();for(var o in e)this[o]=e[o];this.init.apply(this,arguments),e.id&&t.registry.store(this),this._previous=i.clone(this.attributes),this._initted=!0};i.extend(c.prototype,s.Events,f,{idAttribute:"id",idDefinition:{type:"number",setOnce:!0},init:function(){return this},remove:function(){return this.id&&t.registry.remove(this.type,this.id,this._namespace),this.trigger("remove",this),this},set:function(e,t){if(typeof e=="string"&&typeof t!="undefined")this[e]=t;else{this._changing=!0;for(var n in e)this[n]=e[n];this.trigger("change",this,t),this._changing=!1}},get:function(e){return this[e]},addListVal:function(e,t,n){var r=i.clone(this[e])||[];return i(r).contains(t)||(r[n?"unshift":"push"](t),this[e]=r),this},previous:function(e){return e?this._previous[e]:i.clone(this._previous)},removeListVal:function(e,t){var n=i.clone(this[e])||[];return i(n).contains(t)&&(this[e]=i(n).without(t)),this},hasListVal:function(e,t){return i.contains(this[e]||[],t)},_verifyRequired:function(){var e=this.attributes;for(var t in this.definition)if(this.definition[t].required&&typeof e[t]=="undefined")return!1;return!0},_initProperties:function(){function a(n,r,s){var a=t[n]={};if(i.isString(r))o=e._ensureValidType(r),o&&(a.type=o);else{o=e._ensureValidType(r[0]||r.type),o&&(a.type=o);if(r[1]||r.required)a.required=!0;u=r[2]||r.default,u&&(a.value=u),s&&(a.session=!0),r.setOnce&&(a.setOnce=!0)}}var e=this,t=this.definition={},n,r,s,o,u;this.cid=i.uniqueId("model");for(s in this.props)a(s,this.props[s]);for(r in this.session)a(r,this.session[r],!0);t.id?t[this.idAttribute].setOnce=!0:a(this.idAttribute,this.idDefinition),this._registerDerived(),this._createGettersSetters(),this.session&&Object.freeze(this.session),this.props&&Object.freeze(this.props)},_ensureValidType:function(e){return i.contains(["string","number","boolean","array","object","date"],e)?e:undefined},_validate:function(){return!0},_createGettersSetters:function(){var e,t,n,r=this;for(e in this.definition)t=this.definition[e],n={},n.set=function(e,t,n){return function(r,s){var o=s||{},u=typeof r,a,f=r,l=n._changing;n._changing=!0;if(e.type==="date")if(!i.isDate(r))try{f=(new Date(parseInt(r,10))).valueOf(),u="date"}catch(c){u=typeof r}else u="date",f=r.valueOf();else e.type==="array"?u=i.isArray(r)?"array":typeof r:e.type==="object"&&typeof r!="object"&&i.isUndefined(r)&&(f=null,u="object");if(e.type!==u)throw new TypeError("Property '"+t+"' must be of type "+e.type+"."+"Tried to set "+r);if(e.setOnce&&e.value!==undefined&&!i.isEqual(e.value,f))throw new TypeError("Property '"+t+"' can only be set once.");this._previous=i.clone(this.attributes),i.isEqual(e.value,f)||(e.value=f,n._initted&&(n.trigger("change:"+t,n,f,s),(n._deps[t]||[]).forEach(function(e){delete n._cache[e],n.trigger("change:"+e,n,n.derived[e])})),l||(n.trigger("change",n,s),n._changing=!1))}}(t,e,r),n.get=function(e,t){return function(t){if(typeof e.value!="undefined")return e.type==="date"?new Date(e.value):e.value;return}}(t),this.define(e,n);this.defineGetter("attributes",function(){var e={};for(var t in this.definition)e[t]=this[t];return e}),this.defineGetter("keys",function(){return Object.keys(this.attributes)}),this.defineGetter("json",function(){return JSON.stringify(this._getAttributes(!1,!0))}),this.defineGetter("derived",function(){var e={};for(var t in this._derived)e[t]=this._derived[t].fn.apply(this);return e}),this.defineGetter("toTemplate",function(){return i.extend(this._getAttributes(!0),this.derived)})},_getAttributes:function(e,t){var n={};for(var r in this.definition)e?n[r]=t?this.definition[r].value:this[r]:this.definition[r].session||(n[r]=t?this.definition[r].value:this[r]);return n},_registerDerived:function(){var e=this,t;if(!this.derived)return;this._derived=this.derived;for(var n in this.derived)t=this.derived[n].deps,i.isArray(t)||(t=[t]),i.each(t,function(t){e._deps[t]=i(e._deps[t]||[]).union([n])}),this.define(n,{get:i.bind(function(e){return this._derived[e].cache?this._cache.hasOwnProperty(e)?this._cache[e]:this._cache[e]=this._derived[e].fn.apply(this):this._derived[e].fn.apply(this)},this,n),set:i.bind(function(e){throw TypeError(e+" is a derived property, you can't set it directly")},this,n)})}}),t.Model.extend=a}).call(this);