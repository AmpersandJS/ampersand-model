(function(){"use strict";var t=this,e="undefined"!=typeof exports?exports:t.Strict={},i=(Object.prototype.toString,Array.prototype.slice);e.VERSION="0.0.1";var n=t._;n||"undefined"==typeof require||(n=require("underscore"));var r=t.Backbone;r||"undefined"==typeof require||(r=require("backbone")),r.Collection.prototype._prepareModel=function(t,i){if(t instanceof e.Model)return t.collection||(t.collection=this),t;i||(i={}),i.collection=this;var n=new this.model(t,i);return n._validate(t,i)?n:(this.trigger("invalid",this,t,i),!1)};var s=function(){},o=function(t,e,i){var r;return r=e&&e.hasOwnProperty("constructor")?e.constructor:function(){return t.apply(this,arguments)},n.extend(r,t),s.prototype=t.prototype,r.prototype=new s,e&&n.extend(r.prototype,e),i&&n.extend(r,i),r.prototype.constructor=r,r.__super__=t.prototype,r},u=function(t,e){var i=o(this,t,e);return i.extend=this.extend,i},h=e.Mixins={define:function(t,e){Object.defineProperty(this,t,e)},defineGetter:function(t,e){this.define(t,{get:e.bind(this)})},defineSetter:function(t,e){this.define(t,{set:e.bind(this)})}},a=e.Registry=function(){this._cache={},this._namespaces={}};n.extend(a.prototype,{_getCache:function(t){return t?(this._namespaces[t]||(this._namespaces[t]={}),this._namespaces[t]):this._cache},lookup:function(t,e,i){var n=this._getCache(i);return n&&n[t+e]},store:function(t){var e=this._getCache(t._namespace),i=t.type+t.getId();return e[i]=e[i]||t,this},remove:function(t,e,i){var n=this._getCache(i);return this.lookup.apply(this,arguments)?(delete n[t+e],!0):!1},clear:function(){this._cache={},this._namespaces={}}}),e.registry=new a;var c=e.Model=function(t,i){t||(t={}),i||(i={}),this.collection=i.collection||void 0,i.parse&&(t=this.parse(t,i)||{}),i._attrs=t,this._namespace=i.namespace,this._initted=!1,this._deps={},this._initProperties(),this._initCollections(),this._cache={},this._verifyRequired(),this.set(t,n.extend({silent:!0},i)),this.changed={},this.initialize.apply(this,arguments),t[this.idAttribute]&&e.registry.store(this),this._initted=!0,this._previousAttributes={},this.seal&&Object.seal(this)};n.extend(c.prototype,r.Events,h,{idAttribute:"id",getId:function(){return this.get(this.idAttribute)},initialize:function(){return this},parse:function(t){return t},remove:function(){return this.getId()&&e.registry.remove(this.type,this.getId(),this._namespace),this.trigger("remove",this),this.off(),this},set:function(t,e,i){var r,s,o,u,h,a,c,d,f,p,l,v,y=this;if(n.isObject(t)||null===t?(f=t,i=e):(f={},f[t]=e),i=i||{},!this._validate(f,i))return!1;l=i.unset,p=i.silent,u=[],r=this._changing,this._changing=!0,r||(this._previousAttributes=this._getAttributes(!0),this.changed={}),s=this.attributes,o=this._previousAttributes;for(d in f){if(v=f[d],h=typeof v,a=v,c=this.definition[d]||{},"date"===c.type)if(n.isDate(v))h="date",a=v.valueOf();else try{a=new Date(parseInt(v,10)).valueOf(),h="date"}catch(g){h=typeof v}else"array"===c.type?h=n.isArray(v)?"array":typeof v:"object"===c.type&&"object"!=typeof v&&n.isUndefined(v)&&(a=null,h="object");if(c.type&&c.type!==h&&!c.required&&!n.isUndefined(v))throw new TypeError("Property '"+d+"' must be of type "+c.type+". Tried to set "+v);if(c.setOnce&&void 0!==c.value&&!n.isEqual(c.value,a))throw new TypeError("Property '"+t+"' can only be set once.");n.isEqual(c.value,a)||u.push({prev:c.value,val:a,key:d}),n.isEqual(o[d],v)?delete y.changed[d]:y.changed[d]=v}if(n.each(u,function(t){y._previousAttributes&&(y._previousAttributes[t.key]=t.prev),l?delete y.definition[t.key].value:y.definition[t.key].value=t.val}),p||(u.length&&(y._pending=!0),n.each(u,function(t){y.trigger("change:"+t.key,y,y[t.key]),(y._deps[t.key]||[]).forEach(function(t){delete y._cache[t],y.trigger("change:"+t,y,y.derived[t])})})),r)return this;if(!p)for(;this._pending;)this._pending=!1,this.trigger("change",this,i);return this._pending=!1,this._changing=!1,this},get:function(t){return this[t]},previousAttributes:function(){return n.clone(this._previousAttributes)},save:function(t,e,i){var r,s,o;if(this.attributes,null==t||"object"==typeof t?(r=t,i=e):(r={})[t]=e,i=n.extend({validate:!0},i),r&&!i.wait){if(!this.set(r,i))return!1}else if(!this._validate(r,i))return!1;void 0===i.parse&&(i.parse=!0);var u=this,h=i.success;return i.success=function(t){var e=u.parse(t,i);return i.wait&&(e=n.extend(r||{},e)),n.isObject(e)&&!u.set(e,i)?!1:(h&&h(u,t,i),u.trigger("sync",u,t,i),void 0)},f(this,i),s=this.isNew()?"create":i.patch?"patch":"update","patch"===s&&(i.attrs=r),i.wait&&(i.attrs=n.extend(u.attributes,r)),o=this.sync(s,this,i)},fetch:function(t){t=t?n.clone(t):{},void 0===t.parse&&(t.parse=!0);var e=this,i=t.success;return t.success=function(n){i&&i(e,n,t),e.trigger("sync",e,n,t)},f(this,t),this.sync("read",this,t)},destroy:function(t){t=t?n.clone(t):{};var e=this,i=t.success,r=function(){e.trigger("destroy",e,e.collection,t)};if(t.success=function(n){(t.wait||e.isNew())&&r(),i&&i(e,n,t),e.isNew()||e.trigger("sync",e,n,t)},this.isNew())return t.success(),!1;f(this,t);var s=this.sync("delete",this,t);return t.wait||r(),s},hasChanged:function(t){return null==t?!n.isEmpty(this.changed):n.has(this.changed,t)},changedAttributes:function(t){if(!t)return this.hasChanged()?n.clone(this.changed):!1;var e,i=!1,r=this._changing?this._previousAttributes:this._getAttributes(!0);for(var s in t)n.isEqual(r[s],e=t[s])||((i||(i={}))[s]=e);return i},toJSON:function(){return this.attributes},has:function(t){return null!=this.get(t)},url:function(){var t=n.result(this,"urlRoot")||n.result(this.collection,"url")||p();return this.isNew()?t:t+("/"===t.charAt(t.length-1)?"":"/")+encodeURIComponent(this.getId())},isNew:function(){return null==this.getId()},clone:function(){return new this.constructor(this._getAttributes(!0))},isValid:function(t){return this._validate({},n.extend(t||{},{validate:!0}))},escape:function(t){return n.escape(this[t])},sync:function(){return r.sync.apply(this,arguments)},unset:function(t,e){var i,r=this.definition[t],s=r.type;return r.required?(n.isUndefined(r.default)?"string"===s?i="":"object"===s?i={}:"array"===s&&(i=[]):i=r.default,this.set(t,i,e)):this.set(t,i,n.extend({},e,{unset:!0}))},clear:function(t){var e=this;return n.each(this._getAttributes(!0),function(i,n){e.unset(n,t)}),this},_validate:function(t,e){if(!e.validate||!this.validate)return!0;t=n.extend({},this.attributes,t);var i=this.validationError=this.validate(t,e)||null;return i?(this.trigger("invalid",this,i,n.extend(e||{},{validationError:i})),!1):!0},addListVal:function(t,e,i){var r=n.clone(this[t])||[];return n(r).contains(e)||(r[i?"unshift":"push"](e),this[t]=r),this},previous:function(t){return null!=t&&Object.keys(this._previousAttributes).length?this._previousAttributes[t]:null},removeListVal:function(t,e){var i=n.clone(this[t])||[];return n(i).contains(e)&&(this[t]=n(i).without(e)),this},hasListVal:function(t,e){return n.contains(this[t]||[],e)},_initCollections:function(){var t;if(this.collections)for(t in this.collections)this[t]=new this.collections[t],this[t].parent=this},_verifyRequired:function(){var t=this.attributes;for(var e in this.definition)if(this.definition[e].required&&"undefined"==typeof t[e])return!1;return!0},_initProperties:function(){function t(t,e,i){var u=o[t]={};n.isString(e)?(r=s._ensureValidType(e),r&&(u.type=r)):(r=s._ensureValidType(e[0]||e.type),r&&(u.type=r),(e[1]||e.required)&&(u.required=!0),u.value=n.isUndefined(e[2])?e.default:e[2],i&&(u.session=!0),e.setOnce&&(u.setOnce=!0))}var e,i,r,s=this,o=this.definition={};this.cid=n.uniqueId("model");for(i in this.props)t(i,this.props[i]);for(e in this.session)t(e,this.session[e],!0);o[this.idAttributes]&&(o[this.idAttribute].setOnce=!0),this._registerDerived(),this._createGettersSetters(),this.session&&Object.freeze(this.session),this.derived&&Object.freeze(this.derived),this.props&&Object.freeze(this.props)},_ensureValidType:function(t){return n.contains(["string","number","boolean","array","object","date"],t)?t:void 0},_createGettersSetters:function(){var t,e,i,r=this;for(t in this.definition)e=this.definition[t],i={},i.set=function(t,e){return function(t){r.set(e,t)}}(e,t),i.get=function(t){return function(){return"undefined"!=typeof t.value?"date"===t.type?new Date(t.value):t.value:void 0}}(e),this.define(t,i);this.defineGetter("attributes",function(){return this._getAttributes()}),this.defineGetter("json",function(){return JSON.stringify(this._getAttributes(!1,!0))}),this.defineGetter("derived",function(){var t={};for(var e in this._derived)t[e]=this._derived[e].fn.apply(this);return t}),this.defineGetter("toTemplate",function(){return n.extend(this._getAttributes(!0),this.derived)})},_getAttributes:function(t,e){var i,n={};for(var r in this.definition)(t||!this.definition[r].session)&&(i=e?this.definition[r].value:this[r],void 0!==i&&(n[r]=i));return n},_registerDerived:function(){var t,e=this;if(this.derived){this._derived=this.derived;for(var i in this.derived)t=this.derived[i].deps||[],n.each(t,function(t){e._deps[t]=n(e._deps[t]||[]).union([i])}),this.define(i,{get:n.bind(function(t){return this._derived[t].cache?this._cache.hasOwnProperty(t)?this._cache[t]:this._cache[t]=this._derived[t].fn.apply(this):this._derived[t].fn.apply(this)},this,i),set:n.bind(function(t){var e=this._derived[t].deps,i='"'+t+"\" is a derived property, you can't set it directly.";throw e&&e.length?new TypeError(i+' It is dependent on "'+e.join('" and "')+'".'):new TypeError(i)},this,i)})}}});var d=["keys","values","pairs","invert","pick","omit"];n.each(d,function(t){c.prototype[t]=function(){var e=i.call(arguments);return e.unshift(this.attributes),n[t].apply(n,e)}}),e.Model.extend=u,c.prototype.init=c.prototype.initialize;var f=function(t,e){var i=e.error;e.error=function(n){i&&i(t,n,e),t.trigger("error",t,n,e)}},p=function(){throw new Error('A "url" property or function must be specified')}}).call(this);