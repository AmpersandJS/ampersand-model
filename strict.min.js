;(function(){"use strict";var root=this;var Strict=typeof exports!=="undefined"?exports:root.Strict={},toString=Object.prototype.toString,slice=Array.prototype.slice;Strict.VERSION="0.0.1";var _=root._;if(!_&&typeof require!=="undefined")_=require("underscore");var Backbone=root.Backbone;if(!Backbone&&typeof require!=="undefined")Backbone=require("backbone");var Constructor=function(){};var inherits=function(parent,protoProps,staticProps){var child;if(protoProps&&protoProps.hasOwnProperty("constructor")){child=protoProps.constructor}else{child=function(){return parent.apply(this,arguments)}}_.extend(child,parent);Constructor.prototype=parent.prototype;child.prototype=new Constructor;if(protoProps)_.extend(child.prototype,protoProps);if(staticProps)_.extend(child,staticProps);child.prototype.constructor=child;child.__super__=parent.prototype;return child};var extend=function(protoProps,classProps){var child=inherits(this,protoProps,classProps);child.extend=this.extend;return child};var Mixins=Strict.Mixins={define:function(name,def){Object.defineProperty(this,name,def)},defineGetter:function(name,handler){this.define(name,{get:handler.bind(this)})},defineSetter:function(name,handler){this.define(name,{set:handler.bind(this)})}};var Registry=Strict.Registry=function(){this._cache={};this._namespaces={}};_.extend(Registry.prototype,{_getCache:function(ns){if(ns){this._namespaces[ns]||(this._namespaces[ns]={});return this._namespaces[ns]}return this._cache},lookup:function(type,id,ns){var cache=this._getCache(ns);return cache&&cache[type+id]},store:function(model){var cache=this._getCache(model._namespace),key=model.type+model.id;cache[key]=cache[key]||model;return this},remove:function(type,id,ns){var cache=this._getCache(ns);if(this.lookup.apply(this,arguments)){delete cache[type+id];return true}return false},clear:function(){this._cache={};this._namespaces={}}});Strict.registry=new Registry;var Model=Strict.Model=function(attrs,options){attrs=attrs||{};options=options||{};var modelFound,opts=_.defaults(options||{},{seal:true});if(attrs.id){if(modelFound=Strict.registry.lookup(this.type,attrs.id,opts.namespace)){return modelFound}}this._namespace=opts.namespace;this._initted=false;this._deps={};this._initProperties();this._initCollections();this._cache={};this._verifyRequired();this.set(attrs,{silent:true});this.init.apply(this,arguments);if(attrs.id)Strict.registry.store(this);this._previous=_.clone(this.attributes);this._initted=true};_.extend(Model.prototype,Backbone.Events,Mixins,{idAttribute:"id",idDefinition:{type:"number",setOnce:true},init:function(){return this},remove:function(){if(this.id){Strict.registry.remove(this.type,this.id,this._namespace)}this.trigger("remove",this);this.off();return this},set:function(key,value,options){var self=this,changing=self._changing,opts,changes=[],newType,interpretedType,newVal,def,attr,attrs,val;self._changing=true;if(_.isObject(key)||key===null){attrs=key;options=value}else{attrs={};attrs[key]=value}opts=options||{};for(attr in attrs){val=attrs[attr];newType=typeof val;newVal=val;def=this.definition[attr]||{};if(def.type==="date"){if(!_.isDate(val)){try{newVal=new Date(parseInt(val,10)).valueOf();newType="date"}catch(e){newType=typeof val}}else{newType="date";newVal=val.valueOf()}}else if(def.type==="array"){newType=_.isArray(val)?"array":typeof val}else if(def.type==="object"){if(typeof val!=="object"&&_.isUndefined(val)){newVal=null;newType="object"}}if(def.type&&def.type!==newType&&!def.required&&!_.isUndefined(val)){throw new TypeError("Property '"+attr+"' must be of type "+def.type+". Tried to set "+val)}if(def.setOnce&&def.value!==undefined&&!_.isEqual(def.value,newVal)){throw new TypeError("Property '"+key+"' can only be set once.")}if(!_.isEqual(def.value,newVal)){self._previous&&(self._previous[attr]=def.value);def.value=newVal;changes.push(attr)}}_.each(changes,function(key){if(!opts.silent){self.trigger("change:"+key,self,self[key])}(self._deps[key]||[]).forEach(function(derTrigger){delete self._cache[derTrigger];if(!opts.silent)self.trigger("change:"+derTrigger,self,self.derived[derTrigger])})});if(changes.length){if(!opts.silent)self.trigger("change",self)}},get:function(attr){return this[attr]},addListVal:function(prop,value,prepend){var list=_.clone(this[prop])||[];if(!_(list).contains(value)){list[prepend?"unshift":"push"](value);this[prop]=list}return this},previous:function(attr){return attr?this._previous[attr]:_.clone(this._previous)},removeListVal:function(prop,value){var list=_.clone(this[prop])||[];if(_(list).contains(value)){this[prop]=_(list).without(value)}return this},hasListVal:function(prop,value){return _.contains(this[prop]||[],value)},_initCollections:function(){var coll;if(!this.collections)return;for(coll in this.collections){this[coll]=new this.collections[coll];this[coll].parent=this}},_verifyRequired:function(){var attrs=this.attributes;for(var def in this.definition){if(this.definition[def].required&&typeof attrs[def]==="undefined"){return false}}return true},_initProperties:function(){var self=this,definition=this.definition={},val,prop,item,type,filler;this.cid=_.uniqueId("model");function addToDef(name,val,isSession){var def=definition[name]={};if(_.isString(val)){type=self._ensureValidType(val);if(type)def.type=type}else{type=self._ensureValidType(val[0]||val.type);if(type)def.type=type;if(val[1]||val.required)def.required=true;filler=val[2]||val.default;if(filler)def.value=filler;if(isSession)def.session=true;if(val.setOnce)def.setOnce=true}}for(item in this.props){addToDef(item,this.props[item])}for(prop in this.session){addToDef(prop,this.session[prop],true)}if(definition.id){definition[this.idAttribute].setOnce=true}else{addToDef(this.idAttribute,this.idDefinition)}this._registerDerived();this._createGettersSetters();if(this.session)Object.freeze(this.session);if(this.props)Object.freeze(this.props)},_ensureValidType:function(type){return _.contains(["string","number","boolean","array","object","date"],type)?type:undefined},_validate:function(){return true},_createGettersSetters:function(){var item,def,desc,self=this;for(item in this.definition){def=this.definition[item];desc={};desc.set=function(def,item){return function(val,options){self.set(item,val)}}(def,item);desc.get=function(def,attributes){return function(val){if(typeof def.value!=="undefined"){if(def.type==="date"){return new Date(def.value)}return def.value}return}}(def);this.define(item,desc)}this.defineGetter("attributes",function(){var res={};for(var item in this.definition)res[item]=this[item];return res});this.defineGetter("keys",function(){return Object.keys(this.attributes)});this.defineGetter("json",function(){return JSON.stringify(this._getAttributes(false,true))});this.defineGetter("derived",function(){var res={};for(var item in this._derived)res[item]=this._derived[item].fn.apply(this);return res});this.defineGetter("toTemplate",function(){return _.extend(this._getAttributes(true),this.derived)})},_getAttributes:function(includeSession,raw){var res={};for(var item in this.definition){if(!includeSession){if(!this.definition[item].session){res[item]=raw?this.definition[item].value:this[item]}}else{res[item]=raw?this.definition[item].value:this[item]}}return res},_registerDerived:function(){var self=this,depList;if(!this.derived)return;this._derived=this.derived;for(var key in this.derived){depList=this.derived[key].deps||[];_.each(depList,function(dep){self._deps[dep]=_(self._deps[dep]||[]).union([key])});this.define(key,{get:_.bind(function(key){if(this._derived[key].cache){if(this._cache.hasOwnProperty(key)){return this._cache[key]}else{return this._cache[key]=this._derived[key].fn.apply(this)}}else{return this._derived[key].fn.apply(this)}},this,key),set:_.bind(function(key){var deps=this._derived[key].deps,msg='"'+key+"\" is a derived property, you can't set it directly.";if(deps&&deps.length){throw new TypeError(msg+' It is dependent on "'+deps.join('" and "')+'".')}else{throw new TypeError(msg)}},this,key)})}}});Strict.Model.extend=extend;Backbone.Model=Strict.Model}).call(this);