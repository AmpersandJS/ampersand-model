(function(){"use strict";var t=this;Object.prototype.toString;var e,i=Array.prototype.slice,r=t._;r||"undefined"==typeof require||(r=require("underscore"));var n=t.Backbone;n||"undefined"==typeof require||(n=require("backbone")),n.Collection.prototype._prepareModel=function(t,e){if(r.isFunction(t.initialize))return t.collection||(t.collection=this),t;e||(e={}),e.collection=this;var i=new this.model(t,e);return i._validate(t,e)?i:(this.trigger("invalid",this,t,e),!1)};var s=function(t,e){var i=t.length,r=t.indexOf(e)+1;return r>i-1&&(r=0),t[r]},o=function(t,e,i){var n=t._derived[e]={fn:r.isFunction(i)?i:i.fn,cache:i.cache!==!1,depList:i.deps||[]};r.each(n.depList,function(i){t._deps[i]=r(t._deps[i]||[]).union([e])}),Object.defineProperty(t,e,{get:function(){return this._derived[e].cache?this._cache[e]||(this._cache[e]=this._derived[e].fn.apply(this)):this._derived[e].fn.apply(this)},set:function(){throw new TypeError('"'+e+"\" is a derived property, it can't be set directly.")}})},a=function(){this._cache={},this._namespaces={}};r.extend(a.prototype,{_getCache:function(t){return t?(this._namespaces[t]||(this._namespaces[t]={}),this._namespaces[t]):this._cache},lookup:function(t,e,i){var r=this._getCache(i);return r&&r[t+e]},store:function(t){var e=this._getCache(t._namespace),i=t.type+t.getId();return e[i]=e[i]||t,this},remove:function(t,e,i){var r=this._getCache(i);return this.lookup.apply(this,arguments)?(delete r[t+e],!0):!1},clear:function(){this._cache={},this._namespaces={}}});var u=new a,c={date:{set:function(t){var e;if(r.isDate(t))e="date",t=t.valueOf();else try{t=new Date(parseInt(t,10)).valueOf(),e="date"}catch(i){e=typeof t}return{val:t,type:e}},get:function(t){return new Date(t)}},array:{set:function(t){return{val:t,type:r.isArray(t)?"array":typeof t}}},object:{set:function(t){var e=typeof t;return"object"!==e&&r.isUndefined(t)&&(t=null,e="object"),{val:t,type:e}}}};e=function(t){t||(t={});var e,a=function(t,e){t||(t={}),e||(e={}),this.cid=r.uniqueId("model"),this.collection=e.collection||void 0,e.parse&&(t=this.parse(t,e)||{}),this.registry=e.registry||u,e._attrs=t,this._namespace=e.namespace,this._initted=!1,this._values={},this._initCollections(),this._cache={},this._previousAttributes={},this._events={},this.set(t,r.extend({silent:!0},e)),this._changed={},this.initialize.apply(this,arguments),t[this.idAttribute]&&this.registry.store(this),this._initted=!0,this.seal&&Object.seal(this)};Object.defineProperties(a.prototype,{attributes:{get:function(){return this._getAttributes(!0)}},json:{get:function(){return JSON.stringify(this.serialize())}},derived:{get:function(){var t={};for(var e in this._derived)t[e]=this._derived[e].fn.apply(this);return t}},toTemplate:{get:function(){return r.extend(this._getAttributes(!0),this.derived)}}}),r.extend(a.prototype,n.Events,{idAttribute:"id",_derived:{},_deps:{},_definition:{},extraProperties:"ignore",getId:function(){return this.get(this.idAttribute)},initialize:function(){return this},parse:function(t){return t},serialize:function(){return this._getAttributes(!1,!0)},remove:function(){return this.getId()&&this.registry.remove(this.type,this.getId(),this._namespace),this.trigger("remove",this),this.off(),this},set:function(t,e,i){function n(t){m.push(t),r.each(_._deps[t]||[],function(t){n(t)})}var s,o,a,u,h,l,d,f,p,y,v,_=this,g=this.extraProperties;if(r.isObject(t)||null===t?(f=t,i=e):(f={},f[t]=e),i=i||{},!this._validate(f,i))return!1;y=i.unset,p=i.silent,a=[],s=this._changing,this._changing=!0,s||(this._previousAttributes=this._getAttributes(!0),this._changed={}),o=this._previousAttributes;for(d in f){if(h=f[d],u=typeof h,v=this._values[d],l=this._definition[d],!l){if("ignore"===g)continue;if("reject"===g)throw new TypeError('No "'+d+'" property defined on '+(this.type||"this")+" model and allowOtherProperties not set.");"allow"===g&&(l=this._createPropertyDefinition(d,"any"))}if(c[l.type]){var b=c[l.type].set(h);h=b.val,u=b.type}if(l.test){var w=l.test(h,u);if(w)throw new TypeError("Property '"+d+"' failed validation with error: "+w)}if(r.isUndefined(h)&&l.required)throw new TypeError("Required property '"+d+"' must be of type "+l.type+". Tried to set "+h);if(r.isNull(h)&&l.required&&!l.allowNull)throw new TypeError("Property '"+d+"' must be of type "+l.type+" (cannot be null). Tried to set "+h);if(l.type&&"any"!==l.type&&l.type!==u&&!r.isNull(h)&&!r.isUndefined(h))throw new TypeError("Property '"+d+"' must be of type "+l.type+". Tried to set "+h);if(l.values&&!r.contains(l.values,h))throw new TypeError("Property '"+d+"' must be one of values: "+l.values.map(function(t){return t.toString()}).join(", "));if(l.setOnce&&void 0!==v&&!r.isEqual(v,h))throw new TypeError("Property '"+t+"' can only be set once.");r.isEqual(v,h)||a.push({prev:v,val:h,key:d}),r.isEqual(o[d],h)?delete _._changed[d]:_._changed[d]=h}r.each(a,function(t){_._previousAttributes[t.key]=t.prev,y?delete _._values[t.key]:_._values[t.key]=t.val});var m=[];if(!p&&a.length&&(_._pending=!0),r.each(a,function(t){n(t.key)}),r.each(r.uniq(m),function(t){var e=_._derived[t];e&&e.cache&&(_._previousAttributes[t]=_._cache[t],delete _._cache[t]),p||_.trigger("change:"+t,_,_[t])}),s)return this;if(!p)for(;this._pending;)this._pending=!1,this.trigger("change",this,i);return this._pending=!1,this._changing=!1,this},get:function(t){return this[t]},toggle:function(t){var e=this._definition[t];if("boolean"===e.type)this[t]=!this[t];else{if(!e||!e.values)throw new TypeError("Can only toggle properties that are type `boolean` or have `values` array.");this[t]=s(e.values,this[t])}return this},previousAttributes:function(){return r.clone(this._previousAttributes)},save:function(t,e,i){var n,s,o;if(this.attributes,null==t||"object"==typeof t?(n=t,i=e):(n={})[t]=e,i=r.extend({validate:!0},i),n&&!i.wait){if(!this.set(n,i))return!1}else if(!this._validate(n,i))return!1;void 0===i.parse&&(i.parse=!0);var a=this,u=i.success;return i.success=function(t){var e=a.parse(t,i);return i.wait&&(e=r.extend(n||{},e)),r.isObject(e)&&!a.set(e,i)?!1:(u&&u(a,t,i),a.trigger("sync",a,t,i),void 0)},h(this,i),s=this.isNew()?"create":i.patch?"patch":"update","patch"===s&&(i.attrs=n),i.wait&&(i.attrs=r.extend(a.serialize(),n)),o=this.sync(s,this,i)},fetch:function(t){t=t?r.clone(t):{},void 0===t.parse&&(t.parse=!0);var e=this,i=t.success;return t.success=function(r){return e.set(e.parse(r,t),t)?(i&&i(e,r,t),e.trigger("sync",e,r,t),void 0):!1},h(this,t),this.sync("read",this,t)},destroy:function(t){t=t?r.clone(t):{};var e=this,i=t.success,n=function(){e.trigger("destroy",e,e.collection,t)};if(t.success=function(r){(t.wait||e.isNew())&&n(),i&&i(e,r,t),e.isNew()||e.trigger("sync",e,r,t)},this.isNew())return t.success(),!1;h(this,t);var s=this.sync("delete",this,t);return t.wait||n(),s},hasChanged:function(t){return null==t?!r.isEmpty(this._changed):r.has(this._changed,t)},changedAttributes:function(t){if(!t)return this.hasChanged()?r.clone(this._changed):!1;var e,i=!1,n=this._changing?this._previousAttributes:this._getAttributes(!0);for(var s in t)r.isEqual(n[s],e=t[s])||((i||(i={}))[s]=e);return i},toJSON:function(){return this.serialize()},has:function(t){return null!=this.get(t)},url:function(){var t=r.result(this,"urlRoot")||r.result(this.collection,"url")||l();return this.isNew()?t:t+("/"===t.charAt(t.length-1)?"":"/")+encodeURIComponent(this.getId())},isNew:function(){return null==this.getId()},clone:function(){return new this.constructor(this._getAttributes(!0))},isValid:function(t){return this._validate({},r.extend(t||{},{validate:!0}))},escape:function(t){return r.escape(this[t])},sync:function(){return n.sync.apply(this,arguments)},unset:function(t,e){var i,n=this._definition[t],s=n.type;return n.required?(i=r.isUndefined(n.default)?this._getDefaultForType(s):n.default,this.set(t,i,e)):this.set(t,i,r.extend({},e,{unset:!0}))},clear:function(t){var e=this;return r.each(this._getAttributes(!0),function(i,r){e.unset(r,t)}),this},_validate:function(t,e){if(!e.validate||!this.validate)return!0;t=r.extend({},this.attributes,t);var i=this.validationError=this.validate(t,e)||null;return i?(this.trigger("invalid",this,i,r.extend(e||{},{validationError:i})),!1):!0},_getDefaultForType:function(t){return"string"===t?"":"object"===t?{}:"array"===t?[]:void 0},addListVal:function(t,e,i){var n=r.clone(this[t])||[];return r(n).contains(e)||(n[i?"unshift":"push"](e),this[t]=n),this},previous:function(t){return null!=t&&Object.keys(this._previousAttributes).length?this._previousAttributes[t]:null},removeListVal:function(t,e){var i=r.clone(this[t])||[];return r(i).contains(e)&&(this[t]=r(i).without(e)),this},hasListVal:function(t,e){return r.contains(this[t]||[],e)},_initCollections:function(){var t;if(this._collections)for(t in this._collections)this[t]=new this._collections[t],this[t].parent=this},_verifyRequired:function(){var t=this._getAttributes(!0);for(var e in this._definition)if(this._definition[e].required&&"undefined"==typeof t[e])return!1;return!0},_createPropertyDefinition:function(t,e,i){var n,s=this,o=this._definition[t]={};return r.isString(e)?(n=this._ensureValidType(e),n&&(o.type=n)):(n=this._ensureValidType(e[0]||e.type),n&&(o.type=n),(e[1]||e.required)&&(o.required=!0),o.default=r.isUndefined(e[2])?e.default:e[2],o.allowNull=e.allowNull?e.allowNull:!1,e.setOnce&&(o.setOnce=!0),o.required&&r.isUndefined(o.default)&&(o.default=this._getDefaultForType(n)),o.test=e.test,o.values=e.values),i&&(o.session=!0),Object.defineProperty(s,t,{set:function(e){this.set(t,e)},get:function(){var e=this._values[t];return"undefined"!=typeof e?(c[o.type]&&c[o.type].get&&(e=c[o.type].get(e)),e):o.default}}),o},_ensureValidType:function(t){return r.contains(["string","number","boolean","array","object","date","any"].concat(r.keys(c)),t)?t:void 0},_getAttributes:function(t,e){var i,r,n,s={};for(r in this._definition)n=this._definition[r],(!n.session||t&&n.session)&&(i=e?this._values[r]:this[r],"undefined"==typeof i&&(i=n.default),"undefined"!=typeof i&&(s[r]=i));return s}});var d=["keys","values","pairs","invert","pick","omit"];r.each(d,function(t){a.prototype[t]=function(){var e=i.call(arguments);return e.unshift(this.attributes),r[t].apply(r,e)}});for(e in t)"props"===e||"session"===e?r.each(t[e],function(t,i){a.prototype._createPropertyDefinition.call(a.prototype,i,t,"session"===e)}):"derived"===e?r.each(t[e],function(t,e){o(a.prototype,e,t)}):"collections"===e?a.prototype._collections=t[e]:a.prototype[e]=t[e];return a.registry=u,a};var h=function(t,e){var i=e.error;e.error=function(r){i&&i(t,r,e),t.trigger("error",t,r,e)}},l=function(){throw new Error('A "url" property or function must be specified')},d={define:e,registry:u,Registry:a,dataTypes:c};"undefined"!=typeof exports?module.exports=d:window.HumanModel=d}).call(this);